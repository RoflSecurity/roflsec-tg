const { exec } = require("child_process");
const fs = require("fs");
const path = require("path");

module.exports = {
  name: "mp3",
  description: "Download a YouTube video as MP3",
  permissions: "everyone",
  execute: async (ctx) => {
    const url = ctx.message.text.split(" ")[1];
    if (!url) return ctx.reply("❌ Please provide a YouTube URL.");

    const outputDir = path.join(__dirname, "../output");
    if (!fs.existsSync(outputDir)) fs.mkdirSync(outputDir);

    await ctx.reply("⏳ Processing your request, please wait...");

    exec(`splitit "${url}"`, (error) => {
      if (error) return ctx.reply("❌ Error while generating the MP3.");

      // Parcourir output/ et ses sous-dossiers pour trouver le MP3
      const subdirs = fs.readdirSync(outputDir).map(f => path.join(outputDir, f)).filter(f => fs.statSync(f).isDirectory());
      if (!subdirs.length) return ctx.reply("❌ No subfolder found in output directory.");

      const mp3Files = fs.readdirSync(subdirs[0]).map(f => path.join(subdirs[0], f)).filter(f => f.endsWith(".mp3"));
      if (!mp3Files.length) return ctx.reply("❌ No MP3 file found.");

      const filePath = mp3Files[0];
      ctx.replyWithDocument({ source: filePath }).then(() => {
        // Suppression du MP3 et du dossier horodaté
        mp3Files.forEach(f => fs.unlinkSync(f));
        fs.rmdirSync(subdirs[0]);
      });
    });
  }
};
